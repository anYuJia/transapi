# ============================================
# AntiHub Plugin - Docker Compose
# ============================================
# 纯应用镜像，连接现有的 PostgreSQL 和 Redis
# ============================================
#
# 【快速开始】
# 1. cp env.example .env
# 2. vim .env  # 填入现有的数据库和 Redis 地址
# 3. docker-compose up -d --build
#
# 【现有 PostgreSQL 数据库初始化】
# 1. 登录现有的 PG: psql -h $DB_HOST -U $DB_USER
# 2. 创建数据库: CREATE DATABASE antigv;
# 3. 导入表结构: \i schema.sql
# ============================================

services:
  # 主应用服务
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: anticloud-api
    restart: unless-stopped
    ports:
      - "8045:8045"
    environment:
      # PostgreSQL 配置（连接你现有的 PG 容器/实例）
      # 不用在容器里跑 PG，直接连现有的就行
      - DB_HOST=${DB_HOST}           # 例如: 192.168.1.100 或 pg-container-name
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME}           # 新建的数据库名
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}

      # Redis 配置（共用你现有的 Redis）
      - REDIS_HOST=${REDIS_HOST}     # 例如: redis-container-name 或 192.168.1.100
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # OAuth 回调地址
      - OAUTH_CALLBACK_URL=${OAUTH_CALLBACK_URL}

      # 管理员 API Key
      - ADMIN_API_KEY=${ADMIN_API_KEY}

      - PORT=8045
      - NODE_ENV=production

    # 注意：不支持挂载 config.json（容器启动会覆盖生成 /app/config.json）；请用环境变量配置

    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8045/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - anticloud-network

networks:
  anticloud-network:
    driver: bridge
